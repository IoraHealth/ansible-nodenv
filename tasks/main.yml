---
# tasks file for nrser.nodenv

- name: install nodenv
  git:
    repo: "{{ nodenv_github_base_url }}/nodenv"
    dest: ~/.nodenv
    version: "{{ v1.0.0 }}"

- name: add nodenv path line to shell config file
  lineinfile:
    line: export PATH="$HOME/.nodenv/bin:$PATH"
    dest: "{{ nodenv_shell_config_file }}"

- name: add nodenv init line to shell config file
  lineinfile:
    line: eval "$(nodenv init -)"
    dest: "{{ nodenv_shell_config_file }}"

- name: install node-build
  git:
    repo: "{{ nodenv_github_base_url }}/node-build.git"
    dest: ~/.nodenv/plugins/node-build

- name: install node.js versions
  command: ~/.nodenv/bin/nodenv install {{ item }}
  when: item not in nodenv_installed_versions
  with_items: "{{ nodenv_node_versions }}"

# set the global
- name: get global node version
  shell: ~/.nodenv/bin/nodenv global
  register: nodenv_current_global
  changed_when: false
  when: nodenv_global is defined

- name: set global node version
  command: ~/.nodenv/bin/nodenv global {{ nodenv_global }}
  when: nodenv_global is defined and nodenv_current_global.stdout != nodenv_global
